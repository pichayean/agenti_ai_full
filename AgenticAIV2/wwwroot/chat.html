<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>AgenticAI Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --border-subtle: #e5e5e5;
            --accent: #10a37f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: stretch;
        }

        #chatbox {
            flex: 1;
            max-width: 960px;
            height: 100vh;
            background: var(--card-bg);
            border-radius: 0;
            box-shadow: none;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            #chatbox {
                margin: 16px;
                height: calc(100vh - 32px);
                border-radius: 12px;
                box-shadow: 0 4px 16px #00000015;
            }
        }

        /* ====== HEADER ====== */
        #chat-header {
            padding: 4px 4px 12px;
            border-bottom: 1px solid #e5e5e5;
            margin-bottom: 8px;
        }

        #chat-header-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }

        #chat-header-subtitle {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 10px;
            background: #f7f7f8;
            border: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }

        .message {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            font-size: 15px;
            line-height: 1.6;
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-header {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .message.user {
            background: #dff1ff;
            color: #064a7a;
            align-self: flex-end;
        }

        .message.bot {
            background: #eeeeef;
            color: #333;
            align-self: flex-start;
        }

        .message.typing {
            opacity: 0.7;
            font-style: italic;
        }

        .message-content {
            font-size: 15px;
        }

        /* markdown styles inside bot message */
        .message.bot .message-content h1,
        .message.bot .message-content h2,
        .message.bot .message-content h3 {
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .message.bot .message-content p {
            margin: 4px 0;
        }

        .message.bot .message-content ul,
        .message.bot .message-content ol {
            padding-left: 20px;
            margin: 4px 0;
        }

        .message.bot .message-content code {
            font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            background: #e4e4e7;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .message.bot .message-content pre {
            background: #111827;
            color: #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
        }

        .message-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .details-btn {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            background: #ffffff;
            color: var(--accent);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

            .details-btn:hover {
                background: #ecfdf5;
            }

        #input-area {
            display: flex;
            gap: 8px;
            padding-top: 4px;
            border-top: 1px solid #e5e5e5;
        }

        /* ====== INPUT + PLUS BUTTON ====== */
        .input-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        #input {
            flex: 1;
            padding: 12px;
            padding-right: 42px; /* เว้นที่ให้ปุ่ม + */
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 15px;
            outline: none;
            transition: 0.2s;
            width: 100%;
        }

            #input:focus {
                border-color: var(--accent);
                box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.2);
            }

        #suggest-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 999px;
            border: 1px solid var(--accent);
            background: #ffffff;
            color: var(--accent);
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

            #suggest-btn:hover {
                background: #ecfdf5;
            }

        #send {
            padding: 12px 18px;
            background: var(--accent);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            transition: 0.2s;
            white-space: nowrap;
        }

            #send:hover {
                background: #0d8768;
            }

        /* ====== TOOLTIP ตัวอย่างคำถาม ====== */
        #suggest-tooltip {
            position: absolute;
            bottom: 110%;
            right: 0;
            background: #111827;
            color: #f9fafb;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 13px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            min-width: 230px;
            display: none;
            z-index: 20;
        }

            #suggest-tooltip.active {
                display: block;
            }

        .suggest-tooltip-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .suggest-item {
            width: 100%;
            border: none;
            background: transparent;
            color: inherit;
            text-align: left;
            padding: 4px 0;
            cursor: pointer;
            font-size: 13px;
        }

            .suggest-item:hover {
                text-decoration: underline;
            }

        /* Modal */
        #journal-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

            #journal-modal.active {
                display: flex;
            }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
        }

        .modal-content {
            position: relative;
            background: #ffffff;
            max-width: 720px;
            width: 90%;
            max-height: 80vh;
            border-radius: 12px;
            padding: 20px 20px 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 51;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            overflow-y: auto;
            padding-right: 4px;
        }

        .journal-step {
            border-left: 3px solid var(--accent);
            padding-left: 10px;
            margin: 8px 0;
        }

        .journal-step-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .journal-step-body {
            font-size: 14px;
            color: #374151;
            white-space: pre-wrap;
        }

        #email-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

            #email-modal.active {
                display: flex;
            }

    </style>
</head>
<body>
    <div id="chatbox">
        <!-- HEADER -->
        <div id="chat-header">
            <div id="chat-header-title">ระบบ Agentic AI + MCP</div>
            <div id="chat-header-subtitle">ช่วยตอบคำถามและเรียกใช้ MCP tools สำหรับงานของคุณ</div>
        </div>

        <div id="messages"></div>

        <div id="input-area">
            <div class="input-wrapper">
                <input id="input" type="text" placeholder="พิมพ์ข้อความ..." autocomplete="off" />
                <button id="suggest-btn" type="button">+</button>

                <!-- Tooltip ตัวอย่างคำถาม -->
                <div id="suggest-tooltip">
                    <div class="suggest-tooltip-title">ตัวอย่างคำถาม</div>
                    <button type="button"
                            class="suggest-item"
                            data-question="ดึงพอร์ตสินเชื่อทั้งหมดแล้วสรุปรายงาน ส่งเมลหาทีมบัญชี">
                        • ดึงพอร์ตสินเชื่อทั้งหมดแล้วสรุปรายงาน ส่งเมลหาทีมบัญชี
                    </button>
                    <button type="button"
                            class="suggest-item"
                            data-question="สรุปคิวติดตามหนี้ที่ค้างเกิน 30 วัน พร้อมอีเมลแจ้งเตือนทีมติดตามหนี้">
                        • สรุปคิวติดตามหนี้ที่ค้างเกิน 30 วัน พร้อมอีเมลแจ้งเตือนทีมติดตามหนี้
                    </button>
                    <button type="button"
                            class="suggest-item"
                            data-question="สรุปยอดชำระเงินช่วงวันที่ 2025-10-01 ถึง 2025-10-31 เฉพาะวิธี TRANSFER แล้วส่งอีเมลรายงานให้ทีมบัญชี">
                        • สรุปยอดชำระเงินช่วงวันที่ 2025-10-01 ถึง 2025-10-31 เฉพาะวิธี TRANSFER แล้วส่งอีเมลรายงานให้ทีมบัญชี
                    </button>
                </div>
            </div>

            <button id="send">ส่ง</button>
        </div>
    </div>

    <!-- Modal สำหรับ Journal -->
    <div id="journal-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">รายละเอียดการทำงาน (Journal)</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="journal-steps">
                <!-- steps will be rendered here -->
            </div>
        </div>
    </div>
    <!-- Modal สำหรับ Email -->
    <div id="email-modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">รายละเอียดอีเมล</div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="email-content">
            </div>
        </div>
    </div>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ตั้งค่า marked ให้อ่าน newline แบบสวย ๆ
        marked.setOptions({
            gfm: true,
            breaks: true
        });

        const messages = document.getElementById('messages');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');

        const journalModal = document.getElementById('journal-modal');
        const journalStepsEl = document.getElementById('journal-steps');
        const modalBackdrop = journalModal.querySelector('.modal-backdrop');
        const modalClose = journalModal.querySelector('.modal-close');

        // tooltip / suggestion
        const suggestBtn = document.getElementById('suggest-btn');
        const suggestTooltip = document.getElementById('suggest-tooltip');
        const suggestItems = document.querySelectorAll('.suggest-item');

        let typingBubble = null;
        let typingProgressText = '';
        const decoder = new TextDecoder();

        function openJournalModal(journal) {
            journalStepsEl.innerHTML = '';

            if (!journal) {
                const div = document.createElement('div');
                div.textContent = 'ไม่มีข้อมูล Journal ที่จะแสดง';
                journalStepsEl.appendChild(div);
                journalModal.classList.add('active');
                return;
            }

            // ✅ เคสใหม่: model แบบ { RunId, Steps: [...] }
            if (journal.RunId && Array.isArray(journal.Steps)) {
                // แสดง RunId ด้านบน
                const runWrapper = document.createElement('div');
                runWrapper.className = 'journal-step';

                const runTitle = document.createElement('div');
                runTitle.className = 'journal-step-title';
                runTitle.textContent = 'Run Id';

                const runBody = document.createElement('div');
                runBody.className = 'journal-step-body';
                runBody.textContent = journal.RunId;

                runWrapper.appendChild(runTitle);
                runWrapper.appendChild(runBody);
                journalStepsEl.appendChild(runWrapper);

                // แสดง Steps ทีละอัน
                journal.Steps.forEach((step, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'journal-step';

                    const title = document.createElement('div');
                    title.className = 'journal-step-title';

                    const stepId = step.Id || `ขั้นตอนที่ ${idx + 1}`;
                    const status = step.Status ? ` (${step.Status})` : '';
                    title.textContent = `${idx + 1}. ${stepId}${status}`;

                    const body = document.createElement('div');
                    body.className = 'journal-step-body';

                    const lines = [];

                    if (step.DurationMs != null) {
                        lines.push(`ระยะเวลา: ${step.DurationMs} ms`);
                    }

                    // ⬇️ ดึง Input มาก่อน (ตามที่ขอให้แสดง Input ก่อน Output)
                    if (step.Input != null) {
                        let inputText = '';

                        if (typeof step.Input === 'string') {
                            const trimmed = step.Input.trim();
                            if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                                try {
                                    const parsed = JSON.parse(trimmed);
                                    inputText = JSON.stringify(parsed, null, 2);
                                } catch {
                                    inputText = step.Input;
                                }
                            } else {
                                inputText = step.Input;
                            }
                        } else if (typeof step.Input === 'object') {
                            // เคส Input แบบ { content: [ { type: "text", text: "..." } ], ... }
                            if (Array.isArray(step.Input.content) && step.Input.content.length > 0) {
                                const first = step.Input.content[0];
                                if (first && typeof first.text === 'string') {
                                    const txt = first.text.trim();
                                    if (txt.startsWith('{') || txt.startsWith('[')) {
                                        try {
                                            const parsed = JSON.parse(txt);
                                            inputText = JSON.stringify(parsed, null, 2);
                                        } catch {
                                            inputText = first.text;
                                        }
                                    } else {
                                        inputText = first.text;
                                    }
                                } else {
                                    inputText = JSON.stringify(step.Input, null, 2);
                                }
                            } else {
                                inputText = JSON.stringify(step.Input, null, 2);
                            }
                        }

                        if (inputText) {
                            lines.push('Input:');
                            lines.push(inputText);
                        }
                    }

                    // 🔍 Output ตามหลัง Input
                    if (step.Output != null) {
                        let outputText = '';

                        if (typeof step.Output === 'string') {
                            const trimmed = step.Output.trim();
                            if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                                try {
                                    const parsed = JSON.parse(trimmed);
                                    outputText = JSON.stringify(parsed, null, 2);
                                } catch {
                                    outputText = step.Output;
                                }
                            } else {
                                outputText = step.Output;
                            }
                        } else if (typeof step.Output === 'object') {
                            // เคส Output แบบ { content: [ { type: "text", text: "..." } ], ... }
                            if (Array.isArray(step.Output.content) && step.Output.content.length > 0) {
                                const first = step.Output.content[0];
                                if (first && typeof first.text === 'string') {
                                    const txt = first.text.trim();
                                    if (txt.startsWith('{') || txt.startsWith('[')) {
                                        try {
                                            const parsed = JSON.parse(txt);
                                            outputText = JSON.stringify(parsed, null, 2);
                                        } catch {
                                            outputText = first.text;
                                        }
                                    } else {
                                        outputText = first.text;
                                    }
                                } else {
                                    outputText = JSON.stringify(step.Output, null, 2);
                                }
                            } else {
                                outputText = JSON.stringify(step.Output, null, 2);
                            }
                        }

                        if (outputText) {
                            lines.push('Output:');
                            lines.push(outputText);
                        }
                    }

                    if (step.Error) {
                        lines.push('');
                        lines.push('Error:');
                        lines.push(typeof step.Error === 'string'
                            ? step.Error
                            : JSON.stringify(step.Error, null, 2));
                    }

                    body.textContent = lines.join('\n');
                    wrapper.appendChild(title);
                    wrapper.appendChild(body);
                    journalStepsEl.appendChild(wrapper);
                });

                journalModal.classList.add('active');
                return;
            }

            // ✅ fallback: เคสเดิมที่ journal เป็น array ของ string / object ธรรมดา
            if (Array.isArray(journal) && journal.length > 0) {
                journal.forEach((step, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'journal-step';

                    const title = document.createElement('div');
                    title.className = 'journal-step-title';

                    if (typeof step === 'string') {
                        title.textContent = `ขั้นตอนที่ ${idx + 1}`;
                        const body = document.createElement('div');
                        body.className = 'journal-step-body';
                        body.textContent = step;
                        wrapper.appendChild(title);
                        wrapper.appendChild(body);
                    } else {
                        title.textContent = step.title || `ขั้นตอนที่ ${idx + 1}`;
                        const body = document.createElement('div');
                        body.className = 'journal-step-body';
                        body.textContent = step.detail || step.description || JSON.stringify(step, null, 2);
                        wrapper.appendChild(title);
                        wrapper.appendChild(body);
                    }

                    journalStepsEl.appendChild(wrapper);
                });
            } else {
                const div = document.createElement('div');
                div.textContent = 'ไม่มีข้อมูล Journal ที่จะแสดง';
                journalStepsEl.appendChild(div);
            }

            journalModal.classList.add('active');
        }


        function closeJournalModal() {
            journalModal.classList.remove('active');
        }

        modalBackdrop.addEventListener('click', closeJournalModal);
        modalClose.addEventListener('click', closeJournalModal);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeJournalModal();
        });

        /** user message */
        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'message user';

            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = '🧑';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;

            div.appendChild(header);
            div.appendChild(content);

            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        /** bot message with markdown + optional journal button */


        //function appendBotMessage(markdownText, journal) {
        //    const div = document.createElement('div');
        //    div.className = 'message bot';

        //    const header = document.createElement('div');
        //    header.className = 'message-header';
        //    header.textContent = '🤖';

        //    const content = document.createElement('div');
        //    content.className = 'message-content';

        //    try {
        //        const safeText = markdownText || '';
        //        content.innerHTML = marked.parse(safeText);
        //    } catch (e) {
        //        console.error('markdown parse error', e);
        //        content.textContent = markdownText || '';
        //    }

        //    div.appendChild(header);
        //    div.appendChild(content);

        //    if (journal) {
        //        const footer = document.createElement('div');
        //        footer.className = 'message-footer';

        //        const btn = document.createElement('button');
        //        btn.className = 'details-btn';
        //        btn.type = 'button';
        //        btn.textContent = 'ดูรายละเอียดการทำงาน';

        //        btn.addEventListener('click', () => {
        //            openJournalModal(journal);
        //        });

        //        footer.appendChild(btn);
        //        div.appendChild(footer);
        //    }

        //    messages.appendChild(div);
        //    messages.scrollTop = messages.scrollHeight;
        //}
        function appendBotMessage(markdownText, journal, email) {
            const div = document.createElement('div');
            div.className = 'message bot';

            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = '🤖';

            const content = document.createElement('div');
            content.className = 'message-content';

            try {
                content.innerHTML = marked.parse(markdownText || '');
            } catch {
                content.textContent = markdownText || '';
            }

            div.appendChild(header);
            div.appendChild(content);

            // footer buttons
            if (journal || email) {
                const footer = document.createElement('div');
                footer.className = 'message-footer';

                // Journal button
                if (journal) {
                    const btn = document.createElement('button');
                    btn.className = 'details-btn';
                    btn.textContent = 'ดูรายละเอียดการทำงาน';
                    btn.onclick = () => openJournalModal(journal);
                    footer.appendChild(btn);
                }

                // Email button
                if (email) {
                    const eBtn = document.createElement('button');
                    eBtn.className = 'details-btn';
                    eBtn.innerHTML = '📧 ดูอีเมลที่ส่งแล้ว';
                    eBtn.onclick = () => openEmailModal(email);
                    footer.appendChild(eBtn);
                }

                div.appendChild(footer);
            }

            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function openEmailModal(emailData) {
            const modal = document.getElementById('email-modal');
            const content = document.getElementById('email-content');

            let data = null;

            try {
                // ถ้าเป็น string → parse
                if (typeof emailData === 'string') {
                    data = JSON.parse(emailData);
                } else {
                    data = emailData;
                }
            } catch (e) {
                console.error('Invalid email json:', e);
                data = null;
            }

            const args = data?.Args;

            if (!args) {
                content.innerHTML = `<p>ไม่พบข้อมูลอีเมล</p>`;
            } else {
                const toList = Array.isArray(args.to) ? args.to.join(', ') : '(ไม่มีผู้รับ)';
                const subject = args.subject || '(ไม่มีหัวข้อ)';
                const body = args.body_text || args.body || '';

                content.innerHTML = `
            <div><strong>📨 To:</strong> ${toList}</div>
            <div><strong>📧 Subject:</strong> ${subject}</div>
            <hr>
            <div>${marked.parse(body)}</div>
        `;
            }

            modal.classList.add('active');

            // close events
            modal.querySelector('.modal-backdrop').onclick = () => modal.classList.remove('active');
            modal.querySelector('.modal-close').onclick = () => modal.classList.remove('active');
        }


        /** typing bubble (ใช้โชว์ process status) */
        function showTyping(text) {
            if (!typingBubble) {
                typingBubble = document.createElement('div');
                typingBubble.className = 'message bot typing';
                typingBubble.textContent = text;
                messages.appendChild(typingBubble);
            } else {
                typingBubble.textContent = text;
            }
            messages.scrollTop = messages.scrollHeight;
        }

        function removeTyping() {
            if (typingBubble) {
                typingBubble.remove();
                typingBubble = null;
            }
            typingProgressText = '';
        }

        // จัดการ event แต่ละอันที่ได้จาก SSE
        function handleEventData(raw) {
            const msg = (raw || '').trim();

            // ถ้าเป็น FINAL: ... ให้เคลียร์ process และ parse JSON
            if (msg.startsWith('FINAL:')) {
                // clear process status ทั้งหมด
                removeTyping();

                const jsonPart = msg.substring('FINAL:'.length).trim();
                let payload;
                console.log(jsonPart)

                try {
                    payload = JSON.parse(jsonPart);
                } catch (e) {
                    console.error('FINAL JSON parse error:', e, jsonPart);
                    // ถ้า parse ไม่ได้ แสดง raw ไปก่อน
                    appendBotMessage(jsonPart || 'ไม่สามารถอ่านผลลัพธ์สุดท้ายได้', []);
                    return;
                }
                console.log(payload)

                // รองรับชื่อ field หลายแบบ: Final / final / answer
                //const finalText =
                //    payload.Final ??
                //    payload.final ??
                //    payload.answer ??
                //    '';

                //const journal =
                //    payload.Journal ??
                //    payload.journal ??
                //    [];
                //console.log(journal)

                //appendBotMessage(finalText || 'ไม่พบฟิลด์ Final ในผลลัพธ์', journal);
                const finalText =
                    payload.Final ??
                    payload.final ??
                    payload.answer ??
                    '';

                const journal =
                    payload.Journal ??
                    payload.journal ??
                    null;

                const email =
                    payload.Email ??
                    payload.email ??
                    null;

                appendBotMessage(finalText || 'ไม่พบฟิลด์ Final ในผลลัพธ์', journal, email);
                return;
            }

            // ไม่ใช่ FINAL ถือเป็น progress
            typingProgressText = typingProgressText
                ? typingProgressText + '\n' + msg
                : msg;

            showTyping(typingProgressText);
        }

        async function handleSend() {
            const text = input.value.trim();
            if (!text) return;

            appendUserMessage(text);
            input.value = '';
            input.focus();

            typingProgressText = '';
            showTyping('กำลังประมวลผล...');

            if (window.currentSSE) {
                window.currentSSE.close();
            }

            const resp = await fetch('/Chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            if (!resp.body || !window.ReadableStream) {
                removeTyping();
                appendBotMessage('เบราว์เซอร์ไม่รองรับ SSE หรือเกิดข้อผิดพลาด', []);
                return;
            }

            const reader = resp.body.getReader();
            let buffer = '';

            function processBuffer() {
                let idx;
                while ((idx = buffer.indexOf('\n\n')) !== -1) {
                    const chunk = buffer.slice(0, idx);
                    buffer = buffer.slice(idx + 2);

                    if (chunk.startsWith('data:')) {
                        const data = chunk.replace(/^data:\s?/, '');
                        handleEventData(data);
                    }
                }
            }

            (async function read() {
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buffer += decoder.decode(value);
                        processBuffer();
                    }
                } catch (e) {
                    console.error('SSE read error', e);
                } finally {
                    // ถ้าไม่มี FINAL เลย ก็ลบ typing ทิ้งเฉย ๆ
                    removeTyping();
                }
            })();
        }

        sendBtn.addEventListener('click', handleSend);

        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // ====== EVENT ปุ่ม + และ tooltip ======
        suggestBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            suggestTooltip.classList.toggle('active');
        });

        // คลิกตัวอย่างแล้วเอา text ไปใส่ช่องข้อความ
        suggestItems.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const q = btn.dataset.question || btn.textContent.trim();
                input.value = q;
                input.focus();
                suggestTooltip.classList.remove('active');
            });
        });

        // คลิกนอก tooltip ให้ปิด
        document.addEventListener('click', () => {
            suggestTooltip.classList.remove('active');
        });

        // กันไม่ให้คลิกด้านใน tooltip แล้วเด้งปิด
        suggestTooltip.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    </script>

</body>
</html>
